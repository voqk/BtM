@page "/plans/{PlanId:guid}"
@using Microsoft.AspNetCore.Authorization
@using BtM.Data
@using BtM.Services
@attribute [Authorize]
@inject WorkoutPlanService PlanService
@inject ExerciseService ExerciseService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Edit Plan</PageTitle>

@if (_plan is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>@_plan.Name</h1>
        <button class="btn btn-outline-secondary" @onclick="GoBack">Back to Plans</button>
    </div>

    @if (_error is not null)
    {
        <div class="alert alert-danger" role="alert">@_error</div>
    }

    @if (_success is not null)
    {
        <div class="alert alert-success" role="alert">@_success</div>
    }

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Rename Plan</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-8">
                    <input @bind="_editedName" class="form-control" />
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary w-100" @onclick="RenamePlanAsync">Rename</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Exercises in Plan</h5>
        </div>
        <div class="card-body">
            @if (!_plan.PlanExercises.Any())
            {
                <p class="text-muted">No exercises added yet. Add one below!</p>
            }
            else
            {
                <table class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Exercise</th>
                            <th>Sets</th>
                            <th>Target Reps</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var pe in _plan.PlanExercises.OrderBy(x => x.OrderIndex))
                        {
                            <tr>
                                <td>@(pe.OrderIndex + 1)</td>
                                <td>
                                    @pe.Exercise.Name
                                    <span class="badge @GetTypeBadgeClass(pe.Exercise.ExerciseType) ms-1">
                                        @pe.Exercise.ExerciseType
                                    </span>
                                </td>
                                @if (_editingPlanExerciseId == pe.Id)
                                {
                                    <td><input type="number" @bind="_editSets" class="form-control form-control-sm" min="1" style="width: 80px" /></td>
                                    <td><input type="number" @bind="_editTargetReps" class="form-control form-control-sm" min="1" style="width: 80px" /></td>
                                    <td>
                                        <button class="btn btn-success btn-sm me-1" @onclick="() => SavePlanExerciseAsync(pe.Id)">Save</button>
                                        <button class="btn btn-secondary btn-sm" @onclick="CancelEditPlanExercise">Cancel</button>
                                    </td>
                                }
                                else
                                {
                                    <td>@pe.Sets</td>
                                    <td>@pe.TargetReps</td>
                                    <td>
                                        <button class="btn btn-outline-primary btn-sm me-1" @onclick="() => StartEditPlanExercise(pe)">Edit</button>
                                        <button class="btn btn-outline-danger btn-sm" @onclick="() => RemoveExerciseAsync(pe.Id)">Remove</button>
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Add Exercise to Plan</h5>
        </div>
        <div class="card-body">
            @if (_exercises is null || !_exercises.Any())
            {
                <p class="text-muted">No exercises available. <a href="/exercises">Create some exercises</a> first!</p>
            }
            else
            {
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Exercise</label>
                        <select @bind="_selectedExerciseId" class="form-select">
                            <option value="">-- Select Exercise --</option>
                            @foreach (var ex in _exercises)
                            {
                                <option value="@ex.Id">@ex.Name (@ex.ExerciseType)</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Sets</label>
                        <input type="number" @bind="_newSets" class="form-control" min="1" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Target Reps</label>
                        <input type="number" @bind="_newTargetReps" class="form-control" min="1" />
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-success w-100" @onclick="AddExerciseAsync">Add</button>
                    </div>
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public Guid PlanId { get; set; }

    private WorkoutPlan? _plan;
    private List<Exercise>? _exercises;
    private string? _userId;
    private string? _error;
    private string? _success;

    private string _editedName = "";
    private Guid? _selectedExerciseId;
    private int _newSets = 3;
    private int _newTargetReps = 10;

    private Guid? _editingPlanExerciseId;
    private int _editSets;
    private int _editTargetReps;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        _userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (_userId is not null)
        {
            await LoadPlanAsync();
            _exercises = await ExerciseService.GetUserExercisesAsync(_userId);
        }
    }

    private async Task LoadPlanAsync()
    {
        _plan = await PlanService.GetPlanAsync(PlanId, _userId!);
        if (_plan is not null)
        {
            _editedName = _plan.Name;
        }
    }

    private void GoBack() => Navigation.NavigateTo("/plans");

    private async Task RenamePlanAsync()
    {
        if (string.IsNullOrWhiteSpace(_editedName))
        {
            _error = "Plan name cannot be empty.";
            return;
        }

        var (success, error) = await PlanService.UpdatePlanNameAsync(PlanId, _userId!, _editedName);

        if (success)
        {
            _success = "Plan renamed!";
            _error = null;
            await LoadPlanAsync();
        }
        else
        {
            _error = error;
            _success = null;
        }
    }

    private async Task AddExerciseAsync()
    {
        if (_selectedExerciseId is null || _selectedExerciseId == Guid.Empty)
        {
            _error = "Please select an exercise.";
            return;
        }

        var (success, error) = await PlanService.AddExerciseToPlanAsync(PlanId, _userId!, _selectedExerciseId.Value, _newSets, _newTargetReps);

        if (success)
        {
            _success = "Exercise added to plan!";
            _error = null;
            _selectedExerciseId = null;
            _newSets = 3;
            _newTargetReps = 10;
            await LoadPlanAsync();
        }
        else
        {
            _error = error;
            _success = null;
        }
    }

    private void StartEditPlanExercise(PlanExercise pe)
    {
        _editingPlanExerciseId = pe.Id;
        _editSets = pe.Sets;
        _editTargetReps = pe.TargetReps;
        _error = null;
        _success = null;
    }

    private void CancelEditPlanExercise()
    {
        _editingPlanExerciseId = null;
    }

    private async Task SavePlanExerciseAsync(Guid planExerciseId)
    {
        var (success, error) = await PlanService.UpdatePlanExerciseAsync(planExerciseId, _userId!, _editSets, _editTargetReps);

        if (success)
        {
            _success = "Exercise updated!";
            _error = null;
            _editingPlanExerciseId = null;
            await LoadPlanAsync();
        }
        else
        {
            _error = error;
            _success = null;
        }
    }

    private async Task RemoveExerciseAsync(Guid planExerciseId)
    {
        var (success, error) = await PlanService.RemoveExerciseFromPlanAsync(planExerciseId, _userId!);

        if (success)
        {
            _success = "Exercise removed from plan.";
            _error = null;
            await LoadPlanAsync();
        }
        else
        {
            _error = error;
            _success = null;
        }
    }

    private static string GetTypeBadgeClass(ExerciseType type) => type switch
    {
        ExerciseType.Standard => "bg-primary",
        ExerciseType.Bodyweight => "bg-success",
        ExerciseType.Assisted => "bg-info",
        _ => "bg-secondary"
    };
}
